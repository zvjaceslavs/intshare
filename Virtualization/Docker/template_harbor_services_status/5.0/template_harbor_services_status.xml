<?xml version="1.0" encoding="UTF-8"?>
<zabbix_export>
  <version>5.0</version>
  <date>2021-11-09T05:24:52Z</date>
  <groups>
    <group>
      <name>Harbor</name>
    </group>
  </groups>
  <templates>
    <template>
      <template>Harbor</template>
      <name>Harbor</name>
      <description>## Overview ``` # Zabbix Template for Harbor This template uses http agent to get informations from [Harbor](https://goharbor.io/) API, such as: 1. Monitor Items 1. Health of services: Core, Jobservice, Redis, Database, Portal, ..., etc 1. System information: Version, Regitstry URL, Has CA Root, ..., etc 1. Statistic: Public/Private Project and Repository count 1. Storage usage 1. Triggers 1. Unhealthy Services 1. Every operations on Harbor (excluding pulling images `PULL\_ARTIFACT`) 1. Insufficient storage size ## Tested version - Harbor: `2.0.1` - Zabbix: `5.0.1` ## Useage 1. Import Templates: Zabbix Web Page --> [Configuration] --> [Templates] --> [Import] this xml file 1. Link this template to an existing host or a new host 1. Update the Macro to specify your Harbor info: [Configuration] --> your host --> [Macros] --> [Inherited and host macros] - {$HARBOR\_PASSWORD} - {$HARBOR\_URL} - {$HARBOR\_USERNAME} ## Reference - [View and Test the Harbor REST API via Swagger](https://goharbor.io/docs/1.10/build-customize-contribute/configure-swagger/) - [Zabbix - HTTP AGENT](https://www.zabbix.com/documentation/current/manual/config/items/itemtypes/http) ``` ## Author Yioda</description>
      <groups>
        <group>
          <name>Harbor</name>
        </group>
      </groups>
      <applications>
        <application>
          <name>Harbor</name>
        </application>
      </applications>
      <items>
        <item>
          <name>System Status Information</name>
          <type>HTTP_AGENT</type>
          <key>harbor.allstatus</key>
          <delay>30s</delay>
          <history>0</history>
          <trends>0</trends>
          <value_type>TEXT</value_type>
          <authtype>BASIC</authtype>
          <username>{$HARBOR_USERNAME}</username>
          <password>{$HARBOR_PASSWORD}</password>
          <applications>
            <application>
              <name>Harbor</name>
            </application>
          </applications>
          <preprocessing>
            <step>
              <type>JSONPATH</type>
              <params>$.body</params>
            </step>
          </preprocessing>
          <url>{$HARBOR_URL}/api/v2.0/health</url>
          <follow_redirects>NO</follow_redirects>
          <output_format>JSON</output_format>
          <verify_peer>YES</verify_peer>
          <verify_host>YES</verify_host>
        </item>
        <item>
          <name>Statistics</name>
          <type>HTTP_AGENT</type>
          <key>harbor.statistics</key>
          <history>0</history>
          <trends>0</trends>
          <value_type>TEXT</value_type>
          <authtype>BASIC</authtype>
          <username>{$HARBOR_USERNAME}</username>
          <password>{$HARBOR_PASSWORD}</password>
          <applications>
            <application>
              <name>Harbor</name>
            </application>
          </applications>
          <preprocessing>
            <step>
              <type>JSONPATH</type>
              <params>$.body</params>
            </step>
          </preprocessing>
          <url>{$HARBOR_URL}/api/v2.0/statistics</url>
          <follow_redirects>NO</follow_redirects>
          <output_format>JSON</output_format>
          <verify_peer>YES</verify_peer>
          <verify_host>YES</verify_host>
        </item>
        <item>
          <name>Private Project Count</name>
          <type>DEPENDENT</type>
          <key>harbor.statistics.private_project_count</key>
          <delay>0</delay>
          <applications>
            <application>
              <name>Harbor</name>
            </application>
          </applications>
          <preprocessing>
            <step>
              <type>JSONPATH</type>
              <params>$.private_project_count</params>
            </step>
          </preprocessing>
          <master_item>
            <key>harbor.statistics</key>
          </master_item>
        </item>
        <item>
          <name>Private Repository Count</name>
          <type>DEPENDENT</type>
          <key>harbor.statistics.private_repo_count</key>
          <delay>0</delay>
          <applications>
            <application>
              <name>Harbor</name>
            </application>
          </applications>
          <preprocessing>
            <step>
              <type>JSONPATH</type>
              <params>$.private_repo_count</params>
            </step>
          </preprocessing>
          <master_item>
            <key>harbor.statistics</key>
          </master_item>
        </item>
        <item>
          <name>Public Project Count</name>
          <type>DEPENDENT</type>
          <key>harbor.statistics.public_project_count</key>
          <delay>0</delay>
          <applications>
            <application>
              <name>Harbor</name>
            </application>
          </applications>
          <preprocessing>
            <step>
              <type>JSONPATH</type>
              <params>$.public_project_count</params>
            </step>
          </preprocessing>
          <master_item>
            <key>harbor.statistics</key>
          </master_item>
        </item>
        <item>
          <name>Public Repository Count</name>
          <type>DEPENDENT</type>
          <key>harbor.statistics.public_repo_count</key>
          <delay>0</delay>
          <trends>356d</trends>
          <applications>
            <application>
              <name>Harbor</name>
            </application>
          </applications>
          <preprocessing>
            <step>
              <type>JSONPATH</type>
              <params>$.public_repo_count</params>
            </step>
          </preprocessing>
          <master_item>
            <key>harbor.statistics</key>
          </master_item>
        </item>
        <item>
          <name>Status</name>
          <type>DEPENDENT</type>
          <key>harbor.status</key>
          <delay>0</delay>
          <description>1: healthy 0: unhealthy</description>
          <applications>
            <application>
              <name>Harbor</name>
            </application>
          </applications>
          <preprocessing>
            <step>
              <type>JSONPATH</type>
              <params>$.status</params>
            </step>
            <step>
              <type>JAVASCRIPT</type>
              <params>if(value == "healthy"){ return 1; } else { return 0; }</params>
            </step>
          </preprocessing>
          <master_item>
            <key>harbor.allstatus</key>
          </master_item>
          <triggers>
            <trigger>
              <expression>{last(#1,1)}=0</expression>
              <name>Harbor services is unhealthy</name>
              <status>DISABLED</status>
              <priority>AVERAGE</priority>
            </trigger>
          </triggers>
        </item>
        <item>
          <name>Status of Core</name>
          <type>DEPENDENT</type>
          <key>harbor.status.core</key>
          <delay>0</delay>
          <description>1: healthy 0: unhealthy</description>
          <applications>
            <application>
              <name>Harbor</name>
            </application>
          </applications>
          <preprocessing>
            <step>
              <type>JSONPATH</type>
              <params>$.components[?(@.name == 'core')].status.first()</params>
            </step>
            <step>
              <type>JAVASCRIPT</type>
              <params>if(value == "healthy"){ return 1; } else { return 0; }</params>
            </step>
          </preprocessing>
          <master_item>
            <key>harbor.allstatus</key>
          </master_item>
          <triggers>
            <trigger>
              <expression>{last(#1,1)}=0</expression>
              <name>Harbor service: Core is unhealthy</name>
              <priority>AVERAGE</priority>
            </trigger>
          </triggers>
        </item>
        <item>
          <name>Status of Database</name>
          <type>DEPENDENT</type>
          <key>harbor.status.database</key>
          <delay>0</delay>
          <description>1: healthy 0: unhealthy</description>
          <applications>
            <application>
              <name>Harbor</name>
            </application>
          </applications>
          <preprocessing>
            <step>
              <type>JSONPATH</type>
              <params>$.components[?(@.name == 'database')].status.first()</params>
            </step>
            <step>
              <type>JAVASCRIPT</type>
              <params>if(value == "healthy"){ return 1; } else { return 0; }</params>
            </step>
          </preprocessing>
          <master_item>
            <key>harbor.allstatus</key>
          </master_item>
          <triggers>
            <trigger>
              <expression>{last(#1,1)}=0</expression>
              <name>Harbor service: Database is unhealthy</name>
              <priority>AVERAGE</priority>
            </trigger>
          </triggers>
        </item>
        <item>
          <name>Status of Jobservice</name>
          <type>DEPENDENT</type>
          <key>harbor.status.jobservice</key>
          <delay>0</delay>
          <description>1: healthy 0: unhealthy</description>
          <applications>
            <application>
              <name>Harbor</name>
            </application>
          </applications>
          <preprocessing>
            <step>
              <type>JSONPATH</type>
              <params>$.components[?(@.name == 'jobservice')].status.first()</params>
            </step>
            <step>
              <type>JAVASCRIPT</type>
              <params>if(value == "healthy"){ return 1; } else { return 0; }</params>
            </step>
          </preprocessing>
          <master_item>
            <key>harbor.allstatus</key>
          </master_item>
          <triggers>
            <trigger>
              <expression>{last(#1,1)}=0</expression>
              <name>Harbor service: Jobservice is unhealthy</name>
              <priority>AVERAGE</priority>
            </trigger>
          </triggers>
        </item>
        <item>
          <name>Status of Notary</name>
          <type>DEPENDENT</type>
          <key>harbor.status.notary</key>
          <delay>0</delay>
          <description>1: healthy 0: unhealthy</description>
          <applications>
            <application>
              <name>Harbor</name>
            </application>
          </applications>
          <preprocessing>
            <step>
              <type>JSONPATH</type>
              <params>$.components[?(@.name == 'notary')].status.first()</params>
            </step>
            <step>
              <type>JAVASCRIPT</type>
              <params>if(value == "healthy"){ return 1; } else { return 0; }</params>
            </step>
          </preprocessing>
          <master_item>
            <key>harbor.allstatus</key>
          </master_item>
        </item>
        <item>
          <name>Status of Portal</name>
          <type>DEPENDENT</type>
          <key>harbor.status.portal</key>
          <delay>0</delay>
          <description>1: healthy 0: unhealthy</description>
          <applications>
            <application>
              <name>Harbor</name>
            </application>
          </applications>
          <preprocessing>
            <step>
              <type>JSONPATH</type>
              <params>$.components[?(@.name == 'portal')].status.first()</params>
            </step>
            <step>
              <type>JAVASCRIPT</type>
              <params>if(value == "healthy"){ return 1; } else { return 0; }</params>
            </step>
          </preprocessing>
          <master_item>
            <key>harbor.allstatus</key>
          </master_item>
          <triggers>
            <trigger>
              <expression>{last(#1,1)}=0</expression>
              <name>Harbor service: Portal is unhealthy</name>
              <priority>AVERAGE</priority>
            </trigger>
          </triggers>
        </item>
        <item>
          <name>Status of Redis</name>
          <type>DEPENDENT</type>
          <key>harbor.status.redis</key>
          <delay>0</delay>
          <description>1: healthy 0: unhealthy</description>
          <applications>
            <application>
              <name>Harbor</name>
            </application>
          </applications>
          <preprocessing>
            <step>
              <type>JSONPATH</type>
              <params>$.components[?(@.name == 'redis')].status.first()</params>
            </step>
            <step>
              <type>JAVASCRIPT</type>
              <params>if(value == "healthy"){ return 1; } else { return 0; }</params>
            </step>
          </preprocessing>
          <master_item>
            <key>harbor.allstatus</key>
          </master_item>
          <triggers>
            <trigger>
              <expression>{last(#1,1)}=0</expression>
              <name>Harbor service: Redis is unhealthy</name>
              <priority>AVERAGE</priority>
            </trigger>
          </triggers>
        </item>
        <item>
          <name>Status of Registry</name>
          <type>DEPENDENT</type>
          <key>harbor.status.registry</key>
          <delay>0</delay>
          <description>1: healthy 0: unhealthy</description>
          <applications>
            <application>
              <name>Harbor</name>
            </application>
          </applications>
          <preprocessing>
            <step>
              <type>JSONPATH</type>
              <params>$.components[?(@.name == 'registry')].status.first()</params>
            </step>
            <step>
              <type>JAVASCRIPT</type>
              <params>if(value == "healthy"){ return 1; } else { return 0; }</params>
            </step>
          </preprocessing>
          <master_item>
            <key>harbor.allstatus</key>
          </master_item>
          <triggers>
            <trigger>
              <expression>{last(#1,1)}=0</expression>
              <name>Harbor service: Registry is unhealthy</name>
              <priority>AVERAGE</priority>
            </trigger>
          </triggers>
        </item>
        <item>
          <name>Status of Registryctl</name>
          <type>DEPENDENT</type>
          <key>harbor.status.registryctl</key>
          <delay>0</delay>
          <description>1: healthy 0: unhealthy</description>
          <applications>
            <application>
              <name>Harbor</name>
            </application>
          </applications>
          <preprocessing>
            <step>
              <type>JSONPATH</type>
              <params>$.components[?(@.name == 'registryctl')].status.first()</params>
            </step>
            <step>
              <type>JAVASCRIPT</type>
              <params>if(value == "healthy"){ return 1; } else { return 0; }</params>
            </step>
          </preprocessing>
          <master_item>
            <key>harbor.allstatus</key>
          </master_item>
          <triggers>
            <trigger>
              <expression>{last(#1,1)}=0</expression>
              <name>Harbor service: RegistryCtl is unhealthy</name>
              <priority>AVERAGE</priority>
            </trigger>
          </triggers>
        </item>
        <item>
          <name>System Information</name>
          <type>HTTP_AGENT</type>
          <key>harbor.system.info</key>
          <delay>5m</delay>
          <history>0</history>
          <trends>0</trends>
          <value_type>TEXT</value_type>
          <authtype>BASIC</authtype>
          <username>{$HARBOR_USERNAME}</username>
          <password>{$HARBOR_PASSWORD}</password>
          <applications>
            <application>
              <name>Harbor</name>
            </application>
          </applications>
          <preprocessing>
            <step>
              <type>JSONPATH</type>
              <params>$.body</params>
            </step>
          </preprocessing>
          <url>{$HARBOR_URL}/api/v2.0/systeminfo</url>
          <follow_redirects>NO</follow_redirects>
          <output_format>JSON</output_format>
          <verify_peer>YES</verify_peer>
          <verify_host>YES</verify_host>
        </item>
        <item>
          <name>Auth mode</name>
          <type>DEPENDENT</type>
          <key>harbor.system.info.auth_mode</key>
          <delay>0</delay>
          <trends>0</trends>
          <value_type>TEXT</value_type>
          <applications>
            <application>
              <name>Harbor</name>
            </application>
          </applications>
          <preprocessing>
            <step>
              <type>JSONPATH</type>
              <params>$.auth_mode</params>
            </step>
          </preprocessing>
          <master_item>
            <key>harbor.system.info</key>
          </master_item>
        </item>
        <item>
          <name>External URL</name>
          <type>DEPENDENT</type>
          <key>harbor.system.info.external_url</key>
          <delay>0</delay>
          <trends>0</trends>
          <value_type>TEXT</value_type>
          <applications>
            <application>
              <name>Harbor</name>
            </application>
          </applications>
          <preprocessing>
            <step>
              <type>JSONPATH</type>
              <params>$.external_url</params>
            </step>
          </preprocessing>
          <master_item>
            <key>harbor.system.info</key>
          </master_item>
        </item>
        <item>
          <name>Has CA Root</name>
          <type>DEPENDENT</type>
          <key>harbor.system.info.has_ca_root</key>
          <delay>0</delay>
          <trends>0</trends>
          <value_type>TEXT</value_type>
          <applications>
            <application>
              <name>Harbor</name>
            </application>
          </applications>
          <preprocessing>
            <step>
              <type>JSONPATH</type>
              <params>$.has_ca_root</params>
            </step>
          </preprocessing>
          <master_item>
            <key>harbor.system.info</key>
          </master_item>
        </item>
        <item>
          <name>Notification Enable</name>
          <type>DEPENDENT</type>
          <key>harbor.system.info.notification_enable</key>
          <delay>0</delay>
          <trends>0</trends>
          <value_type>TEXT</value_type>
          <applications>
            <application>
              <name>Harbor</name>
            </application>
          </applications>
          <preprocessing>
            <step>
              <type>JSONPATH</type>
              <params>$.notification_enable</params>
            </step>
          </preprocessing>
          <master_item>
            <key>harbor.system.info</key>
          </master_item>
        </item>
        <item>
          <name>Project Creation Restriction</name>
          <type>DEPENDENT</type>
          <key>harbor.system.info.project_creation_restriction</key>
          <delay>0</delay>
          <trends>0</trends>
          <value_type>TEXT</value_type>
          <applications>
            <application>
              <name>Harbor</name>
            </application>
          </applications>
          <preprocessing>
            <step>
              <type>JSONPATH</type>
              <params>$.project_creation_restriction</params>
            </step>
          </preprocessing>
          <master_item>
            <key>harbor.system.info</key>
          </master_item>
        </item>
        <item>
          <name>Read Only</name>
          <type>DEPENDENT</type>
          <key>harbor.system.info.read_only</key>
          <delay>0</delay>
          <trends>0</trends>
          <value_type>TEXT</value_type>
          <applications>
            <application>
              <name>Harbor</name>
            </application>
          </applications>
          <preprocessing>
            <step>
              <type>JSONPATH</type>
              <params>$.read_only</params>
            </step>
          </preprocessing>
          <master_item>
            <key>harbor.system.info</key>
          </master_item>
        </item>
        <item>
          <name>Registry Storage Provider Name</name>
          <type>DEPENDENT</type>
          <key>harbor.system.info.registry_storage_provider_name</key>
          <delay>0</delay>
          <trends>0</trends>
          <value_type>TEXT</value_type>
          <applications>
            <application>
              <name>Harbor</name>
            </application>
          </applications>
          <preprocessing>
            <step>
              <type>JSONPATH</type>
              <params>$.registry_storage_provider_name</params>
            </step>
          </preprocessing>
          <master_item>
            <key>harbor.system.info</key>
          </master_item>
        </item>
        <item>
          <name>Registry URL</name>
          <type>DEPENDENT</type>
          <key>harbor.system.info.registry_url</key>
          <delay>0</delay>
          <trends>0</trends>
          <value_type>TEXT</value_type>
          <applications>
            <application>
              <name>Harbor</name>
            </application>
          </applications>
          <preprocessing>
            <step>
              <type>JSONPATH</type>
              <params>$.registry_url</params>
            </step>
          </preprocessing>
          <master_item>
            <key>harbor.system.info</key>
          </master_item>
        </item>
        <item>
          <name>Self Restriction</name>
          <type>DEPENDENT</type>
          <key>harbor.system.info.self_registration</key>
          <delay>0</delay>
          <trends>0</trends>
          <value_type>TEXT</value_type>
          <applications>
            <application>
              <name>Harbor</name>
            </application>
          </applications>
          <preprocessing>
            <step>
              <type>JSONPATH</type>
              <params>$.self_registration</params>
            </step>
          </preprocessing>
          <master_item>
            <key>harbor.system.info</key>
          </master_item>
        </item>
        <item>
          <name>Version</name>
          <type>DEPENDENT</type>
          <key>harbor.system.info.version</key>
          <delay>0</delay>
          <trends>0</trends>
          <value_type>TEXT</value_type>
          <applications>
            <application>
              <name>Harbor</name>
            </application>
          </applications>
          <preprocessing>
            <step>
              <type>JSONPATH</type>
              <params>$.harbor_version</params>
            </step>
          </preprocessing>
          <master_item>
            <key>harbor.system.info</key>
          </master_item>
        </item>
        <item>
          <name>System Volume Information</name>
          <type>HTTP_AGENT</type>
          <key>harbor.system.info.volume</key>
          <delay>30s</delay>
          <history>0</history>
          <trends>0</trends>
          <value_type>TEXT</value_type>
          <authtype>BASIC</authtype>
          <username>{$HARBOR_USERNAME}</username>
          <password>{$HARBOR_PASSWORD}</password>
          <applications>
            <application>
              <name>Harbor</name>
            </application>
          </applications>
          <preprocessing>
            <step>
              <type>JSONPATH</type>
              <params>$.body</params>
            </step>
          </preprocessing>
          <url>{$HARBOR_URL}/api/v2.0/systeminfo/volumes</url>
          <follow_redirects>NO</follow_redirects>
          <output_format>JSON</output_format>
          <verify_peer>YES</verify_peer>
          <verify_host>YES</verify_host>
        </item>
        <item>
          <name>Free volume storage size</name>
          <type>DEPENDENT</type>
          <key>harbor.system.info.volume.storage.free</key>
          <delay>0</delay>
          <units>B</units>
          <applications>
            <application>
              <name>Harbor</name>
            </application>
          </applications>
          <preprocessing>
            <step>
              <type>JSONPATH</type>
              <params>$.storage.free</params>
            </step>
          </preprocessing>
          <master_item>
            <key>harbor.system.info.volume</key>
          </master_item>
        </item>
        <item>
          <name>Free volume storage size (percent)</name>
          <type>CALCULATED</type>
          <key>harbor.system.info.volume.storage.free.percent</key>
          <value_type>FLOAT</value_type>
          <units>%</units>
          <params>100*last("harbor.system.info.volume.storage.free")/last("harbor.system.info.volume.storage.total")</params>
          <applications>
            <application>
              <name>Harbor</name>
            </application>
          </applications>
          <triggers>
            <trigger>
              <expression>{last()}&lt;10</expression>
              <name>Free Harbor volume storage size &lt; 10 %</name>
              <priority>HIGH</priority>
            </trigger>
            <trigger>
              <expression>{last()}&lt;20</expression>
              <name>Free Harbor volume storage size &lt; 20 %</name>
              <priority>AVERAGE</priority>
            </trigger>
          </triggers>
        </item>
        <item>
          <name>Total volume storage size</name>
          <type>DEPENDENT</type>
          <key>harbor.system.info.volume.storage.total</key>
          <delay>0</delay>
          <units>B</units>
          <applications>
            <application>
              <name>Harbor</name>
            </application>
          </applications>
          <preprocessing>
            <step>
              <type>JSONPATH</type>
              <params>$.storage.total</params>
            </step>
          </preprocessing>
          <master_item>
            <key>harbor.system.info.volume</key>
          </master_item>
        </item>
        <item>
          <name>With Chatmuseum</name>
          <type>DEPENDENT</type>
          <key>harbor.system.info.with_chartmuseum</key>
          <delay>0</delay>
          <trends>0</trends>
          <value_type>TEXT</value_type>
          <applications>
            <application>
              <name>Harbor</name>
            </application>
          </applications>
          <preprocessing>
            <step>
              <type>JSONPATH</type>
              <params>$.with_chartmuseum</params>
            </step>
          </preprocessing>
          <master_item>
            <key>harbor.system.info</key>
          </master_item>
        </item>
        <item>
          <name>With Notary</name>
          <type>DEPENDENT</type>
          <key>harbor.system.info.with_notary</key>
          <delay>0</delay>
          <trends>0</trends>
          <value_type>TEXT</value_type>
          <applications>
            <application>
              <name>Harbor</name>
            </application>
          </applications>
          <preprocessing>
            <step>
              <type>JSONPATH</type>
              <params>$.with_notary</params>
            </step>
          </preprocessing>
          <master_item>
            <key>harbor.system.info</key>
          </master_item>
        </item>
        <item>
          <name>Core log watch</name>
          <type>ZABBIX_ACTIVE</type>
          <key>log[/var/log/harbor/core.log,"Handle notification with Handler 'AuditLog' on topic (.*)",,,,\1]</key>
          <delay>20s</delay>
          <history>7d</history>
          <trends>0</trends>
          <value_type>LOG</value_type>
          <description>Core log monitoring</description>
          <applications>
            <application>
              <name>Harbor</name>
            </application>
          </applications>
          <triggers>
            <trigger>
              <expression>{str(PULL)}=0</expression>
              <name>Harbor Operation on {HOST.NAME}</name>
              <priority>INFO</priority>
              <description>Excluding image pulling actions.</description>
              <type>MULTIPLE</type>
              <manual_close>YES</manual_close>
            </trigger>
          </triggers>
        </item>
      </items>
      <macros>
        <macro>
          <macro>{$HARBOR_PASSWORD}</macro>
          <type>SECRET_TEXT</type>
        </macro>
        <macro>
          <macro>{$HARBOR_URL}</macro>
          <value>127.0.0.1</value>
        </macro>
        <macro>
          <macro>{$HARBOR_USERNAME}</macro>
          <type>SECRET_TEXT</type>
        </macro>
      </macros>
    </template>
  </templates>
  <triggers>
    <trigger>
      <expression>{Harbor:harbor.status.notary.last(#1,1)}=0 and {Harbor:harbor.system.info.with_notary.last()}="true"</expression>
      <name>Harbor service: Notary is unhealthy</name>
      <priority>AVERAGE</priority>
    </trigger>
  </triggers>
</zabbix_export>