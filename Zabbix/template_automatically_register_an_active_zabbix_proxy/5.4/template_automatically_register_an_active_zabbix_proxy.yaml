zabbix_export:
  version: '5.4'
  date: '2021-11-09T05:10:55Z'
  groups:
    -
      uuid: 57b7ae836ca64446ba2c296389c009b7
      name: Templates/Modules
  templates:
    -
      uuid: 58c59a0e9d6549ee913d1dc290e6c25e
      template: 'Auto register an active Zabbix proxy'
      name: 'Auto register an active Zabbix proxy'
      description: |
        ## Description
        
        prxid=$(/usr/bin/curl -sk {$Z_API_PHP} -X POST -H "Content-Type: application/json" -d ' { "jsonrpc": "2.0", "method": "proxy.create", "params": { "host": "{EVENT.TAGS}", "status": "5" }, "auth": "{$Z_API_SESSIONID}", "id": 1 } ' | grep -o -E "[0-9]+{3,}") && /usr/bin/curl -sk {$Z_API_PHP} -X POST -H "Content-Type: application/json" -d " { "jsonrpc ": "2.0 ", "method ": "host.create ", "params ": { "host ": "{EVENT.TAGS} ", "interfaces ": [ { "type ": 1, "main ": 1, "useip ": 1, "ip ": "127.0.0.1 ", "dns ": " ", "port ": "10050 " } ], "groups ": [ { "groupid ": "4 " } ], "templates ": [ { "templateid ": "10048 " } ], "proxy_hostid ": "$prxid " }, "auth ": "{$Z_API_SESSIONID} ", "id ": 1 } " && /usr/sbin/zabbix_server -R config_cache_reload && /usr/bin/sleep 20 && /usr/bin/curl -sk {$Z_API_PHP} -X POST -H "Content-Type: application/json" -d ' { "jsonrpc": "2.0", "method": "event.acknowledge", "params": { "eventids": "{EVENT.ID}", "action": 1, "message": "Problem resolved." }, "auth": "{$Z_API_SESSIONID}", "id": 1 } '
        
        ## Overview
        
        The solution is based on log file monitoring and the functionality of the Zabbix API.
        
        
        <https://youtu.be/XET-138UvpY>
        
        
         
        
        
        In order to use this template, it's required to run and maintain an active session-id at a global level:
        
        
        [https://share.zabbix.com/zabbix-tools-and-utilities/maintain-zabbix-api-session-id-in-a-global-level](zabbix-tools-and-utilities/maintain-zabbix-api-session-id-in-a-global-level)
        
        
        <https://youtu.be/MjQJ0g0AaYI>
        
        
         
        
        
        
        
      groups:
        -
          name: Templates/Modules
      items:
        -
          uuid: 80aad3afa33049a791a2819b4f4d4455
          name: 'zabbix_server.log proxy not found'
          type: ZABBIX_ACTIVE
          key: 'log[/var/log/zabbix/zabbix_server.log,"cannot parse proxy data from active proxy at.*proxy.*not found",,,skip,,]'
          delay: 1s
          trends: '0'
          value_type: LOG
          tags:
            -
              tag: Application
              value: Log
          triggers:
            -
              uuid: 81c246760bf24b42bb76166c1c9c1171
              expression: 'find(/Auto register an active Zabbix proxy/log[/var/log/zabbix/zabbix_server.log,"cannot parse proxy data from active proxy at.*proxy.*not found",,,skip,,],,"regexp","proxy.*not found")=1'
              name: '{{ITEM.VALUE}.regsub("(proxy \".*\" not found)",\1)}'
              priority: AVERAGE
              manual_close: 'YES'
              tags:
                -
                  tag: '{{ITEM.VALUE}.regsub("proxy \"(.*)\" not found",\1)}'
