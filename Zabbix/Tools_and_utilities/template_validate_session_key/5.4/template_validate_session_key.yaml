zabbix_export:
  version: '5.4'
  date: '2021-11-21T21:53:35Z'
  groups:
    -
      uuid: 57b7ae836ca64446ba2c296389c009b7
      name: Templates/Modules
  templates:
    -
      uuid: 5e3be60a51cd4e4d98b2836e3ddbea41
      template: 'check if session key is valid api'
      name: 'check if session key is valid api'
      description: |
        ## Description
        
        You may need to obtain a new session key. Replace user 'Admin' and password 'zabbix' curl -s -X POST http://127.0.0.1/api_jsonrpc.php -H 'Content-Type: application/json' -H 'cache-control: no-cache' -d "{ "jsonrpc ": "2.0 ", "method ": "user.login ", "params ":{ "user ": "Admin ", "password ": "zabbix "}, "id ":1}" | grep -E -o "([0-9a-f]{32,32})" curl -s -X POST http://127.0.0.1/zabbix/api_jsonrpc.php -H 'Content-Type: application/json' -H 'cache-control: no-cache' -d "{ "jsonrpc ": "2.0 ", "method ": "user.login ", "params ":{ "user ": "Admin ", "password ": "zabbix "}, "id ":1}" | grep -E -o "([0-9a-f]{32,32})"
        
        ## Overview
        
        It's possible to define a Zabbix session key in a global manner.
        
        
        After that, by using a macro {$APIKEY} and {$JSONRPC.PHP} you can directly use Zabbix API calls in "HTTP Agent" or in the "Action" section.
        
        
        This template helps you to detect if the session key is somehow not valid anymore.
        
        
        {$JSONRPC.PHP} = http://127.0.0.1/zabbix/api\_jsonrpc.php
        
        
        or
        
        
        {$JSONRPC.PHP} = <http://127.0.0.1/api_jsonrpc.php>
        
        
        The first session key can be obtained using:
        
        
        curl -s -X POST http://127.0.0.1/zabbix/api\_jsonrpc.php -H 'Content-Type: application/json' -H 'cache-control: no-cache' -d "{\"jsonrpc\":\"2.0\",\"method\":\"user.login\",\"params\":{\"user\":\"Admin\",\"password\":\"zabbix\"},\"id\":1}" | grep -E -o "([0-9a-f]{32,32})"
        
        
         
        
        
        or:
        
        
        curl -s -X POST http://127.0.0.1/api\_jsonrpc.php -H 'Content-Type: application/json' -H 'cache-control: no-cache' -d "{\"jsonrpc\":\"2.0\",\"method\":\"user.login\",\"params\":{\"user\":\"Admin\",\"password\":\"zabbix\"},\"id\":1}" | grep -E -o "([0-9a-f]{32,32})"
        
        
        Install session key as macro like:
        
        
        {$APIKEY} = 0b0bacc6ebc339e3a89247f20a65c13c
        
        
        
        
      groups:
        -
          name: Templates/Modules
      items:
        -
          uuid: e8ad3b08a7324f7282b14c682e3a53d1
          name: 'check session key'
          type: HTTP_AGENT
          key: check.session.key
          delay: 30s
          trends: '0'
          value_type: TEXT
          preprocessing:
            -
              type: REGEX
              parameters:
                - (html|error|result)
                - \1;result=0;error=1;html=2
            -
              type: REGEX
              parameters:
                - '(html|error|result)(?=.*;\1=(\d))'
                - \2
          url: '{$JSONRPC.PHP}'
          posts: |
            {
                "jsonrpc": "2.0",
                "method": "proxy.get",
                "params": {
                    "output": ["name"]
                },
                "auth": "{$APIKEY}",
                "id": 1
            }
          follow_redirects: 'NO'
          post_type: JSON
          request_method: POST
          output_format: JSON
          tags:
            -
              tag: Application
              value: Session
          triggers:
            -
              uuid: c6afbdcd11354136bbfbc66efd3fd666
              expression: 'last(/check if session key is valid api/check.session.key)=2'
              name: 'invalid url configureded for zabbix api'
              priority: DISASTER
              description: |
                You may need to obtain a new session key. Replace user 'Admin' and password 'zabbix'
                
                curl -s -X POST http://127.0.0.1/api_jsonrpc.php -H 'Content-Type: application/json' -H 'cache-control: no-cache' -d "{\"jsonrpc\":\"2.0\",\"method\":\"user.login\",\"params\":{\"user\":\"Admin\",\"password\":\"zabbix\"},\"id\":1}" | grep -E -o "([0-9a-f]{32,32})"
            -
              uuid: 1f7662c8a3e0457497ae5ec4245b0ddd
              expression: 'last(/check if session key is valid api/check.session.key)=1'
              name: 'session key now valid. http works fine'
              priority: DISASTER
              description: |
                You may need to obtain a new session key. Replace user 'Admin' and password 'zabbix'
                
                curl -s -X POST http://127.0.0.1/api_jsonrpc.php -H 'Content-Type: application/json' -H 'cache-control: no-cache' -d "{\"jsonrpc\":\"2.0\",\"method\":\"user.login\",\"params\":{\"user\":\"Admin\",\"password\":\"zabbix\"},\"id\":1}" | grep -E -o "([0-9a-f]{32,32})"
