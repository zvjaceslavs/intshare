<?xml version="1.0" encoding="UTF-8"?>
<zabbix_export>
    <version>5.2</version>
    <date>2021-03-26T03:46:00Z</date>
    <groups>
        <group>
            <name>Templates/Network devices</name>
        </group>
    </groups>
    <templates>
        <template>
            <template>Juniper BGP</template>
            <name>Juniper BGP</name>
            <groups>
                <group>
                    <name>Templates/Network devices</name>
                </group>
            </groups>
            <applications>
                <application>
                    <name>BGP</name>
                </application>
            </applications>
            <discovery_rules>
                <discovery_rule>
                    <name>BGP peer discovery</name>
                    <type>SNMP_AGENT</type>
                    <snmp_oid>discovery[{#BGPPEERINDEX},.1.3.6.1.4.1.2636.5.1.1.2.1.1.1.14,{#BGPPEERREMOTEADDRESS},1.3.6.1.4.1.2636.5.1.1.2.1.1.1.11, {#BGPEERREMOTEAS},.1.3.6.1.4.1.2636.5.1.1.2.1.1.1.13]</snmp_oid>
                    <key>net.bgp.peer.discovery</key>
                    <delay>10m</delay>
                    <item_prototypes>
                        <item_prototype>
                            <name>Last received error ({#BGPPEERREMOTEADDRESS})</name>
                            <type>SNMP_AGENT</type>
                            <snmp_oid>.1.3.6.1.4.1.2636.5.1.1.2.2.1.1.5.{#SNMPINDEX}</snmp_oid>
                            <key>net.bgp.peer.error.received[{#BGPEERREMOTEAS}, {#BGPPEERREMOTEADDRESS}]</key>
                            <delay>5m</delay>
                            <trends>0</trends>
                            <value_type>TEXT</value_type>
                            <applications>
                                <application>
                                    <name>BGP</name>
                                </application>
                            </applications>
                        </item_prototype>
                        <item_prototype>
                            <name>Last sent error ({#BGPPEERREMOTEADDRESS})</name>
                            <type>SNMP_AGENT</type>
                            <snmp_oid>.1.3.6.1.4.1.2636.5.1.1.2.2.1.1.6.{#SNMPINDEX}</snmp_oid>
                            <key>net.bgp.peer.error.sent[{#BGPEERREMOTEAS}, {#BGPPEERREMOTEADDRESS}]</key>
                            <delay>5m</delay>
                            <trends>0</trends>
                            <value_type>TEXT</value_type>
                            <applications>
                                <application>
                                    <name>BGP</name>
                                </application>
                            </applications>
                        </item_prototype>
                        <item_prototype>
                            <name>IPv4 prefixes accepted ({#BGPPEERREMOTEADDRESS})</name>
                            <type>SNMP_AGENT</type>
                            <snmp_oid>1.3.6.1.4.1.2636.5.1.1.2.6.2.1.8.{#BGPPEERINDEX}.1.1</snmp_oid>
                            <key>net.bgp.peer.prefixes.ipv4.accepted[{#BGPEERREMOTEAS}, {#BGPPEERREMOTEADDRESS}]</key>
                            <delay>2m</delay>
                            <applications>
                                <application>
                                    <name>BGP</name>
                                </application>
                            </applications>
                        </item_prototype>
                        <item_prototype>
                            <name>IPv4 prefixes advertised ({#BGPPEERREMOTEADDRESS})</name>
                            <type>SNMP_AGENT</type>
                            <snmp_oid>.1.3.6.1.4.1.2636.5.1.1.2.6.2.1.10.{#BGPPEERINDEX}.1.1</snmp_oid>
                            <key>net.bgp.peer.prefixes.ipv4.advertised[{#BGPEERREMOTEAS}, {#BGPPEERREMOTEADDRESS}]</key>
                            <delay>2m</delay>
                            <applications>
                                <application>
                                    <name>BGP</name>
                                </application>
                            </applications>
                        </item_prototype>
                        <item_prototype>
                            <name>IPv4 prefixes received ({#BGPPEERREMOTEADDRESS})</name>
                            <type>SNMP_AGENT</type>
                            <snmp_oid>1.3.6.1.4.1.2636.5.1.1.2.6.2.1.7.{#BGPPEERINDEX}.1.1</snmp_oid>
                            <key>net.bgp.peer.prefixes.ipv4.received[{#BGPEERREMOTEAS}, {#BGPPEERREMOTEADDRESS}]</key>
                            <delay>2m</delay>
                            <applications>
                                <application>
                                    <name>BGP</name>
                                </application>
                            </applications>
                        </item_prototype>
                        <item_prototype>
                            <name>IPv4 prefixes rejected ({#BGPPEERREMOTEADDRESS})</name>
                            <type>SNMP_AGENT</type>
                            <snmp_oid>1.3.6.1.4.1.2636.5.1.1.2.6.2.1.9.{#BGPPEERINDEX}.1.1</snmp_oid>
                            <key>net.bgp.peer.prefixes.ipv4.rejected[{#BGPEERREMOTEAS}, {#BGPPEERREMOTEADDRESS}]</key>
                            <delay>2m</delay>
                            <applications>
                                <application>
                                    <name>BGP</name>
                                </application>
                            </applications>
                        </item_prototype>
                        <item_prototype>
                            <name>IPv6 prefixes accepted ({#BGPPEERREMOTEADDRESS})</name>
                            <type>SNMP_AGENT</type>
                            <snmp_oid>1.3.6.1.4.1.2636.5.1.1.2.6.2.1.8.{#BGPPEERINDEX}.2.1</snmp_oid>
                            <key>net.bgp.peer.prefixes.ipv6.accepted[{#BGPEERREMOTEAS}, {#BGPPEERREMOTEADDRESS}]</key>
                            <delay>2m</delay>
                            <applications>
                                <application>
                                    <name>BGP</name>
                                </application>
                            </applications>
                        </item_prototype>
                        <item_prototype>
                            <name>IPv6 prefixes advertised ({#BGPPEERREMOTEADDRESS})</name>
                            <type>SNMP_AGENT</type>
                            <snmp_oid>.1.3.6.1.4.1.2636.5.1.1.2.6.2.1.10.{#BGPPEERINDEX}.2.1</snmp_oid>
                            <key>net.bgp.peer.prefixes.ipv6.advertised[{#BGPEERREMOTEAS}, {#BGPPEERREMOTEADDRESS}]</key>
                            <delay>2m</delay>
                            <applications>
                                <application>
                                    <name>BGP</name>
                                </application>
                            </applications>
                        </item_prototype>
                        <item_prototype>
                            <name>IPv6 prefixes received ({#BGPPEERREMOTEADDRESS})</name>
                            <type>SNMP_AGENT</type>
                            <snmp_oid>1.3.6.1.4.1.2636.5.1.1.2.6.2.1.7.{#BGPPEERINDEX}.2.1</snmp_oid>
                            <key>net.bgp.peer.prefixes.ipv6.received[{#BGPEERREMOTEAS}, {#BGPPEERREMOTEADDRESS}]</key>
                            <delay>2m</delay>
                            <applications>
                                <application>
                                    <name>BGP</name>
                                </application>
                            </applications>
                        </item_prototype>
                        <item_prototype>
                            <name>IPv6 prefixes rejected ({#BGPPEERREMOTEADDRESS})</name>
                            <type>SNMP_AGENT</type>
                            <snmp_oid>1.3.6.1.4.1.2636.5.1.1.2.6.2.1.9.{#BGPPEERINDEX}.2.1</snmp_oid>
                            <key>net.bgp.peer.prefixes.ipv6.rejected[{#BGPEERREMOTEAS}, {#BGPPEERREMOTEADDRESS}]</key>
                            <delay>2m</delay>
                            <applications>
                                <application>
                                    <name>BGP</name>
                                </application>
                            </applications>
                        </item_prototype>
                        <item_prototype>
                            <name>Peer state ({#BGPPEERREMOTEADDRESS})</name>
                            <type>SNMP_AGENT</type>
                            <snmp_oid>.1.3.6.1.4.1.2636.5.1.1.2.1.1.1.2.{#SNMPINDEX}</snmp_oid>
                            <key>net.bgp.peer.state[{#BGPEERREMOTEAS}, {#BGPPEERREMOTEADDRESS}]</key>
                            <applications>
                                <application>
                                    <name>BGP</name>
                                </application>
                            </applications>
                            <valuemap>
                                <name>BgpPeerState</name>
                            </valuemap>
                        </item_prototype>
                        <item_prototype>
                            <name>Administrative status ({#BGPPEERREMOTEADDRESS})</name>
                            <type>SNMP_AGENT</type>
                            <snmp_oid>.1.3.6.1.4.1.2636.5.1.1.2.1.1.1.3.{#SNMPINDEX}</snmp_oid>
                            <key>net.bgp.peer.status[{#BGPEERREMOTEAS}, {#BGPPEERREMOTEADDRESS}]</key>
                            <delay>5m</delay>
                            <applications>
                                <application>
                                    <name>BGP</name>
                                </application>
                            </applications>
                            <valuemap>
                                <name>BgpPeerAdminStatus</name>
                            </valuemap>
                        </item_prototype>
                        <item_prototype>
                            <name>Established time ({#BGPPEERREMOTEADDRESS})</name>
                            <type>SNMP_AGENT</type>
                            <snmp_oid>.1.3.6.1.4.1.2636.5.1.1.2.4.1.1.1.{#SNMPINDEX}</snmp_oid>
                            <key>net.bgp.peer.uptime[{#BGPEERREMOTEAS}, {#BGPPEERREMOTEADDRESS}]</key>
                            <delay>5m</delay>
                            <units>seconds</units>
                            <applications>
                                <application>
                                    <name>BGP</name>
                                </application>
                            </applications>
                        </item_prototype>
                    </item_prototypes>
                    <trigger_prototypes>
                        <trigger_prototype>
                            <expression>{Juniper BGP:net.bgp.peer.state[{#BGPEERREMOTEAS}, {#BGPPEERREMOTEADDRESS}].last()}=6 and {Juniper BGP:net.bgp.peer.prefixes.ipv4.received[{#BGPEERREMOTEAS}, {#BGPPEERREMOTEADDRESS}].last()}&lt;0.8*{Juniper BGP:net.bgp.peer.prefixes.ipv4.received[{#BGPEERREMOTEAS}, {#BGPPEERREMOTEADDRESS}].avg(1d)}</expression>
                            <name>{HOST.HOST} BGP peer {#BGPPEERREMOTEADDRESS} (AS{#BGPEERREMOTEAS}) has lost more than 20% of received prefixes</name>
                            <priority>WARNING</priority>
                        </trigger_prototype>
                        <trigger_prototype>
                            <expression>{Juniper BGP:net.bgp.peer.state[{#BGPEERREMOTEAS}, {#BGPPEERREMOTEADDRESS}].last(#3)}&lt;&gt;6 and {Juniper BGP:net.bgp.peer.status[{#BGPEERREMOTEAS}, {#BGPPEERREMOTEADDRESS}].last()}=2</expression>
                            <name>{HOST.HOST} BGP peer {#BGPPEERREMOTEADDRESS} (AS{#BGPEERREMOTEAS}) is DOWN</name>
                            <priority>HIGH</priority>
                        </trigger_prototype>
                    </trigger_prototypes>
                    <preprocessing>
                        <step>
                            <type>JAVASCRIPT</type>
                            <parameters>
                                <parameter>json = JSON.parse(value);

json.forEach(function (item, index, array) {
    var ip = item[&quot;{#BGPPEERREMOTEADDRESS}&quot;];

    parts = ip.trim().split(' ');

    if (parts.length === 4) {
        for (var i = 0; i &lt; parts.length; ++i) {
            parts[i] = parseInt(parts[i], 16);
        }

        ip = parts.join('.');
    } else {
        var str = parts.join('');
        var parts = str.match(/.{1,4}/g);
        ip = parts.join(&quot;:&quot;);
        ip = ip.replace(/\b(?:0+:){2,}/, ':')
               .split(':')
	       .map(function(octet) {
                   return  octet.replace(/\b0+/g, '');
               })
               .join(':')
               .toLowerCase();
    }

    array[index][&quot;{#BGPPEERREMOTEADDRESS}&quot;] = ip;
});

return JSON.stringify(json);</parameter>
                            </parameters>
                        </step>
                    </preprocessing>
                </discovery_rule>
            </discovery_rules>
        </template>
    </templates>
    <value_maps>
        <value_map>
            <name>BgpPeerAdminStatus</name>
            <mappings>
                <mapping>
                    <value>1</value>
                    <newvalue>stop</newvalue>
                </mapping>
                <mapping>
                    <value>2</value>
                    <newvalue>start</newvalue>
                </mapping>
            </mappings>
        </value_map>
        <value_map>
            <name>BgpPeerState</name>
            <mappings>
                <mapping>
                    <value>1</value>
                    <newvalue>idle</newvalue>
                </mapping>
                <mapping>
                    <value>2</value>
                    <newvalue>connect</newvalue>
                </mapping>
                <mapping>
                    <value>3</value>
                    <newvalue>active</newvalue>
                </mapping>
                <mapping>
                    <value>4</value>
                    <newvalue>opensent</newvalue>
                </mapping>
                <mapping>
                    <value>5</value>
                    <newvalue>openconfirm</newvalue>
                </mapping>
                <mapping>
                    <value>6</value>
                    <newvalue>established</newvalue>
                </mapping>
            </mappings>
        </value_map>
    </value_maps>
</zabbix_export>
