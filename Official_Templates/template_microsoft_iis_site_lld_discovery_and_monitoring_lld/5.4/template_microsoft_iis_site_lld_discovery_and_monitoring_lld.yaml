zabbix_export:
  version: '5.4'
  date: '2021-11-21T21:55:46Z'
  groups:
    -
      uuid: a571c0d144b14fd4a87a9d9b2aa9fcd6
      name: Templates/Applications
  templates:
    -
      uuid: c49c259fac894dd18eafba305d4da729
      template: 'App IIS LLD Sites Monitoring'
      name: 'App IIS LLD Sites Monitoring'
      description: |
        ## Overview
        
        Template uses wmi and powershell methods.
        
        
        Agent 4.4.5 is required for operation.
        
        
         
        
        
         
        
        
        
        ## Author
        
        Serhii Zaitsev
        
        
      groups:
        -
          name: Templates/Applications
      discovery_rules:
        -
          uuid: 30f916fe584a4c72937cdd91845c5f03
          name: 'Discovery Sites'
          key: 'wmi.getall[ROOT\WebAdministration,SELECT * FROM WorkerProcess]'
          delay: 3m
          lifetime: '0'
          item_prototypes:
            -
              uuid: 552171ba5ee54e999554166829485f98
              name: '{#SITENAME} State'
              key: 'system.run[C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe -NoProfile -Nologo "Import-Module WebAdministration;(Get-ItemProperty IIS:\AppPools\{#SITENAME}).state"]'
              delay: 10m
              trends: '0'
              value_type: TEXT
              tags:
                -
                  tag: Application
                  value: 'IIS Sites'
            -
              uuid: 65150d73dfde48f48884f4361d3679c9
              name: '{#SITENAME} Limit Action'
              key: 'system.run[C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe -NoProfile -Nologo "Import-Module WebAdministration;(Get-ItemProperty IIS:\AppPools\{#SITENAME} -Name cpu).action"]'
              delay: 10m
              trends: '0'
              value_type: TEXT
              tags:
                -
                  tag: Application
                  value: 'IIS Sites'
            -
              uuid: c327232b0b0e415f8f9b37bcabc0d34b
              name: '{#SITENAME} CPU Limit'
              key: 'system.run[C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe -NoProfile -Nologo "Import-Module WebAdministration;(Get-ItemProperty IIS:\AppPools\{#SITENAME} -Name cpu).limit"]'
              delay: 10m
              units: '%'
              preprocessing:
                -
                  type: TRIM
                  parameters:
                    - '000'
              tags:
                -
                  tag: Application
                  value: 'IIS Sites'
            -
              uuid: 924f452577cd48c0a91e74fa9c05e784
              name: '{#SITENAME} CPU Usage %'
              key: 'wmi.get[ROOT\CIMV2,"SELECT PercentProcessorTime FROM win32_perfformatteddata_perfproc_process WHERE IDProcess = {#PROCESSID}"]'
              value_type: FLOAT
              units: '%'
              tags:
                -
                  tag: Application
                  value: 'IIS Sites'
              trigger_prototypes:
                -
                  uuid: ca6e0edbdc5e4aca8aa4e854750468f9
                  expression: 'min(/App IIS LLD Sites Monitoring/wmi.get[ROOT\CIMV2,"SELECT PercentProcessorTime FROM win32_perfformatteddata_perfproc_process WHERE IDProcess = {#PROCESSID}"],5m)>={$SITE_CPU_ALERT}'
                  name: '{#SITENAME} High CPU Usage'
                  opdata: '{ITEM.VALUE}'
                  priority: HIGH
                  manual_close: 'YES'
            -
              uuid: 5223e193776b4b038b112538c0102a0d
              name: '{#SITENAME} Memory Usage'
              key: 'wmi.get[ROOT\CIMV2,SELECT WorkingSet FROM win32_perfformatteddata_perfproc_process WHERE IDProcess = {#PROCESSID}]'
              units: B
              tags:
                -
                  tag: Application
                  value: 'IIS Sites'
            -
              uuid: 801332f7bee84ba49496d9c0a705b6db
              name: '{#SITENAME} ProcessId'
              key: 'wmi.get[ROOT\WebAdministration,SELECT ProcessId FROM WorkerProcess WHERE ProcessId = {#PROCESSID}]'
              delay: 10m
              tags:
                -
                  tag: Application
                  value: 'IIS Sites'
          lld_macro_paths:
            -
              lld_macro: '{#PROCESSID}'
              path: $.ProcessId
            -
              lld_macro: '{#SITENAME}'
              path: $.AppPoolName
      macros:
        -
          macro: '{$SITE_CPU_ALERT}'
          value: '40'
