<?xml version="1.0" encoding="UTF-8"?>
<zabbix_export>
  <version>5.0</version>
  <date>2021-11-09T08:14:36Z</date>
  <groups>
    <group>
      <name>Templates</name>
    </group>
  </groups>
  <templates>
    <template>
      <template>macOS Content Cache</template>
      <name>macOS Content Cache</name>
      <description>## Description Runtime stats and storage monitoring for macOS High Sierra Caching Service. ## Overview With the release of macOS 10.13 High Sierra, Apple have made a big change to their App and iCloud content caching services. This function used to be part of their add-on macOS Server package, but with 10.13 they've moved the feature into the regular macOS operating system. This means that any Macintosh computer running 10.13 High Sierra can serve as a content cache for a local network. The old macOS Server version had fancy logs and graphs that allowed you to monitor cahing performance and activity to keep an eye on the efficacy and health of the service. When they moved it all to regular macOS all that stuff disappeared. It's basically just an on/off checkbox. Instead, there's just a command-line tool that outputs the raw data from the service. You can see the stats by running `AssetCacheManagerUtil status` from a Terminal window. This template parses the JSON output of AssetCacheManagerUtil for monitoring in Zabbix. Requires Zabbix 3.4 and RemoteCommands=1 in the Zabbix Agent.</description>
      <groups>
        <group>
          <name>Templates</name>
        </group>
      </groups>
      <applications>
        <application>
          <name>macOS Content Cache</name>
        </application>
      </applications>
      <items>
        <item>
          <name>Activated</name>
          <type>DEPENDENT</type>
          <key>contentcache.activated</key>
          <delay>0</delay>
          <history>7d</history>
          <description>Content Caching is enabled (true or false)</description>
          <applications>
            <application>
              <name>macOS Content Cache</name>
            </application>
          </applications>
          <preprocessing>
            <step>
              <type>JSONPATH</type>
              <params>$.result.Activated</params>
            </step>
            <step>
              <type>BOOL_TO_DECIMAL</type>
              <params></params>
            </step>
          </preprocessing>
          <master_item>
            <key>system.run[/usr/bin/AssetCacheManagerUtil status --json 2> /dev/null]</key>
          </master_item>
        </item>
        <item>
          <name>Active</name>
          <type>DEPENDENT</type>
          <key>contentcache.active</key>
          <delay>0</delay>
          <history>7d</history>
          <description>Content Caching is running (true or false)</description>
          <applications>
            <application>
              <name>macOS Content Cache</name>
            </application>
          </applications>
          <preprocessing>
            <step>
              <type>JSONPATH</type>
              <params>$.result.Active</params>
            </step>
            <step>
              <type>BOOL_TO_DECIMAL</type>
              <params></params>
            </step>
          </preprocessing>
          <master_item>
            <key>system.run[/usr/bin/AssetCacheManagerUtil status --json 2> /dev/null]</key>
          </master_item>
          <triggers>
            <trigger>
              <expression>{last()}=0</expression>
              <name>macOS Content Caching service is not running on {HOST.NAME}</name>
              <url>https://support.apple.com/en-ca/HT208025</url>
              <priority>WARNING</priority>
              <description>The Content Caching sharing service is not running on this macOS host.</description>
            </trigger>
          </triggers>
        </item>
        <item>
          <name>Bytes Imported</name>
          <type>DEPENDENT</type>
          <key>contentcache.bytes.imported</key>
          <delay>0</delay>
          <history>7d</history>
          <units>Bps</units>
          <description>Bytes Imported by Caching Service</description>
          <applications>
            <application>
              <name>macOS Content Cache</name>
            </application>
          </applications>
          <preprocessing>
            <step>
              <type>JSONPATH</type>
              <params>$.result.TotalBytesImported</params>
            </step>
            <step>
              <type>CHANGE_PER_SECOND</type>
              <params></params>
            </step>
          </preprocessing>
          <master_item>
            <key>system.run[/usr/bin/AssetCacheManagerUtil status --json 2> /dev/null]</key>
          </master_item>
        </item>
        <item>
          <name>Bytes Returned to Clients</name>
          <type>DEPENDENT</type>
          <key>contentcache.bytes.returnedtoclients</key>
          <delay>0</delay>
          <history>7d</history>
          <units>Bps</units>
          <description>Download rate (bytes per second) to local macOS and iOS clients</description>
          <applications>
            <application>
              <name>macOS Content Cache</name>
            </application>
          </applications>
          <preprocessing>
            <step>
              <type>JSONPATH</type>
              <params>$.result.TotalBytesReturnedToClients</params>
            </step>
            <step>
              <type>CHANGE_PER_SECOND</type>
              <params></params>
            </step>
          </preprocessing>
          <master_item>
            <key>system.run[/usr/bin/AssetCacheManagerUtil status --json 2> /dev/null]</key>
          </master_item>
        </item>
        <item>
          <name>Bytes Stored from Origin</name>
          <type>DEPENDENT</type>
          <key>contentcache.bytes.storedfromorigin</key>
          <delay>0</delay>
          <history>7d</history>
          <units>Bps</units>
          <description>Download rate (bytes per second) from Apple's app and iCloud servers</description>
          <applications>
            <application>
              <name>macOS Content Cache</name>
            </application>
          </applications>
          <preprocessing>
            <step>
              <type>JSONPATH</type>
              <params>$.result.TotalBytesStoredFromOrigin</params>
            </step>
            <step>
              <type>CHANGE_PER_SECOND</type>
              <params></params>
            </step>
          </preprocessing>
          <master_item>
            <key>system.run[/usr/bin/AssetCacheManagerUtil status --json 2> /dev/null]</key>
          </master_item>
        </item>
        <item>
          <name>Cache Limit</name>
          <type>DEPENDENT</type>
          <key>contentcache.cachelimit</key>
          <delay>0</delay>
          <history>7d</history>
          <units>B</units>
          <description>Content Caching configured maximum storage (bytes)</description>
          <applications>
            <application>
              <name>macOS Content Cache</name>
            </application>
          </applications>
          <preprocessing>
            <step>
              <type>JSONPATH</type>
              <params>$.result.CacheLimit</params>
            </step>
          </preprocessing>
          <master_item>
            <key>system.run[/usr/bin/AssetCacheManagerUtil status --json 2> /dev/null]</key>
          </master_item>
        </item>
        <item>
          <name>Cache Used</name>
          <type>DEPENDENT</type>
          <key>contentcache.cacheused</key>
          <delay>0</delay>
          <history>7d</history>
          <units>B</units>
          <description>Content Caching storage in use</description>
          <applications>
            <application>
              <name>macOS Content Cache</name>
            </application>
          </applications>
          <preprocessing>
            <step>
              <type>JSONPATH</type>
              <params>$.result.CacheUsed</params>
            </step>
          </preprocessing>
          <master_item>
            <key>system.run[/usr/bin/AssetCacheManagerUtil status --json 2> /dev/null]</key>
          </master_item>
        </item>
        <item>
          <name>Stored: Books</name>
          <type>DEPENDENT</type>
          <key>contentcache.details.books</key>
          <delay>0</delay>
          <history>7d</history>
          <units>B</units>
          <description>Amount of data currently in cache for "Books"</description>
          <applications>
            <application>
              <name>macOS Content Cache</name>
            </application>
          </applications>
          <preprocessing>
            <step>
              <type>JSONPATH</type>
              <params>$.result.CacheDetails.Books</params>
            </step>
          </preprocessing>
          <master_item>
            <key>system.run[/usr/bin/AssetCacheManagerUtil status --json 2> /dev/null]</key>
          </master_item>
        </item>
        <item>
          <name>Stored: iCloud</name>
          <type>DEPENDENT</type>
          <key>contentcache.details.icloud</key>
          <delay>0</delay>
          <history>7d</history>
          <units>B</units>
          <description>Amount of data currently in cache for "iCloud"</description>
          <applications>
            <application>
              <name>macOS Content Cache</name>
            </application>
          </applications>
          <preprocessing>
            <step>
              <type>JSONPATH</type>
              <params>$.result.CacheDetails.iCloud</params>
            </step>
          </preprocessing>
          <master_item>
            <key>system.run[/usr/bin/AssetCacheManagerUtil status --json 2> /dev/null]</key>
          </master_item>
        </item>
        <item>
          <name>Stored: iOS Software</name>
          <type>DEPENDENT</type>
          <key>contentcache.details.ios</key>
          <delay>0</delay>
          <history>7d</history>
          <units>B</units>
          <description>Amount of data currently in cache for "iOS Software"</description>
          <applications>
            <application>
              <name>macOS Content Cache</name>
            </application>
          </applications>
          <preprocessing>
            <step>
              <type>JSONPATH</type>
              <params>$.result.CacheDetails['iOS Software']</params>
            </step>
          </preprocessing>
          <master_item>
            <key>system.run[/usr/bin/AssetCacheManagerUtil status --json 2> /dev/null]</key>
          </master_item>
        </item>
        <item>
          <name>Stored: macOS Software</name>
          <type>DEPENDENT</type>
          <key>contentcache.details.macos</key>
          <delay>0</delay>
          <history>7d</history>
          <units>B</units>
          <description>Amount of data currently in cache for "macOS Software"</description>
          <applications>
            <application>
              <name>macOS Content Cache</name>
            </application>
          </applications>
          <preprocessing>
            <step>
              <type>JSONPATH</type>
              <params>$.result.CacheDetails['Mac Software']</params>
            </step>
          </preprocessing>
          <master_item>
            <key>system.run[/usr/bin/AssetCacheManagerUtil status --json 2> /dev/null]</key>
          </master_item>
        </item>
        <item>
          <name>Stored: Other</name>
          <type>DEPENDENT</type>
          <key>contentcache.details.other</key>
          <delay>0</delay>
          <history>7d</history>
          <units>B</units>
          <description>Amount of data currently in cache for "Other"</description>
          <applications>
            <application>
              <name>macOS Content Cache</name>
            </application>
          </applications>
          <preprocessing>
            <step>
              <type>JSONPATH</type>
              <params>$.result.CacheDetails.Other</params>
            </step>
          </preprocessing>
          <master_item>
            <key>system.run[/usr/bin/AssetCacheManagerUtil status --json 2> /dev/null]</key>
          </master_item>
        </item>
        <item>
          <name>Server GUID</name>
          <type>DEPENDENT</type>
          <key>contentcache.guid</key>
          <delay>0</delay>
          <history>7d</history>
          <trends>0</trends>
          <value_type>CHAR</value_type>
          <description>Apple-generated server GUID</description>
          <applications>
            <application>
              <name>macOS Content Cache</name>
            </application>
          </applications>
          <preprocessing>
            <step>
              <type>JSONPATH</type>
              <params>$.result.ServerGUID</params>
            </step>
          </preprocessing>
          <master_item>
            <key>system.run[/usr/bin/AssetCacheManagerUtil status --json 2> /dev/null]</key>
          </master_item>
        </item>
        <item>
          <name>iCloud Content Free</name>
          <type>DEPENDENT</type>
          <key>contentcache.icloudfree</key>
          <delay>0</delay>
          <history>7d</history>
          <units>B</units>
          <applications>
            <application>
              <name>macOS Content Cache</name>
            </application>
          </applications>
          <preprocessing>
            <step>
              <type>JSONPATH</type>
              <params>$.result.PersonalCacheFree</params>
            </step>
          </preprocessing>
          <master_item>
            <key>system.run[/usr/bin/AssetCacheManagerUtil status --json 2> /dev/null]</key>
          </master_item>
        </item>
        <item>
          <name>iCloud Content Limit</name>
          <type>DEPENDENT</type>
          <key>contentcache.icloudlimit</key>
          <delay>0</delay>
          <history>7d</history>
          <units>B</units>
          <applications>
            <application>
              <name>macOS Content Cache</name>
            </application>
          </applications>
          <preprocessing>
            <step>
              <type>JSONPATH</type>
              <params>$.result.PersonalCacheLimit</params>
            </step>
          </preprocessing>
          <master_item>
            <key>system.run[/usr/bin/AssetCacheManagerUtil status --json 2> /dev/null]</key>
          </master_item>
        </item>
        <item>
          <name>iCloud Content Used</name>
          <type>DEPENDENT</type>
          <key>contentcache.icloudused</key>
          <delay>0</delay>
          <history>7d</history>
          <units>B</units>
          <applications>
            <application>
              <name>macOS Content Cache</name>
            </application>
          </applications>
          <preprocessing>
            <step>
              <type>JSONPATH</type>
              <params>$.result.PersonalCacheUsed</params>
            </step>
          </preprocessing>
          <master_item>
            <key>system.run[/usr/bin/AssetCacheManagerUtil status --json 2> /dev/null]</key>
          </master_item>
        </item>
        <item>
          <name>Registered</name>
          <type>DEPENDENT</type>
          <key>contentcache.registered</key>
          <delay>0</delay>
          <history>7d</history>
          <description>Content Caching is registered with Apple's servers (true or false)</description>
          <applications>
            <application>
              <name>macOS Content Cache</name>
            </application>
          </applications>
          <preprocessing>
            <step>
              <type>JSONPATH</type>
              <params>$.result.RegistrationStatus</params>
            </step>
            <step>
              <type>BOOL_TO_DECIMAL</type>
              <params></params>
            </step>
          </preprocessing>
          <master_item>
            <key>system.run[/usr/bin/AssetCacheManagerUtil status --json 2> /dev/null]</key>
          </master_item>
        </item>
        <item>
          <name>Startup Status</name>
          <type>DEPENDENT</type>
          <key>contentcache.startupstatus</key>
          <delay>0</delay>
          <history>7d</history>
          <trends>0</trends>
          <value_type>CHAR</value_type>
          <description>Startup Status (normally "OK")</description>
          <applications>
            <application>
              <name>macOS Content Cache</name>
            </application>
          </applications>
          <preprocessing>
            <step>
              <type>JSONPATH</type>
              <params>$.result.StartupStatus</params>
            </step>
          </preprocessing>
          <master_item>
            <key>system.run[/usr/bin/AssetCacheManagerUtil status --json 2> /dev/null]</key>
          </master_item>
        </item>
        <item>
          <name>Total Cached Data Returned to Clients</name>
          <type>CALCULATED</type>
          <key>contentcache.total.cacheddatareturned</key>
          <delay>60s</delay>
          <history>7d</history>
          <units>B</units>
          <params>last(contentcache.total.returnedtoclients)-last(contentcache.total.storedfromorigin)</params>
          <description>Total data returned to clients from cache</description>
          <applications>
            <application>
              <name>macOS Content Cache</name>
            </application>
          </applications>
        </item>
        <item>
          <name>Cache Hit Rate</name>
          <type>CALCULATED</type>
          <key>contentcache.total.hitrate</key>
          <delay>60s</delay>
          <history>7d</history>
          <units>%</units>
          <params>last(contentcache.total.cacheddatareturned)/last(contentcache.total.returnedtoclients)*100</params>
          <description>Ratio of cached data to uncached data sent to clients as a percentage (greater than 100% is possible)</description>
          <applications>
            <application>
              <name>macOS Content Cache</name>
            </application>
          </applications>
        </item>
        <item>
          <name>Total Returned to Clients</name>
          <type>DEPENDENT</type>
          <key>contentcache.total.returnedtoclients</key>
          <delay>0</delay>
          <history>7d</history>
          <units>B</units>
          <description>Total data returned to clients</description>
          <applications>
            <application>
              <name>macOS Content Cache</name>
            </application>
          </applications>
          <preprocessing>
            <step>
              <type>JSONPATH</type>
              <params>$.result.TotalBytesReturnedToClients</params>
            </step>
          </preprocessing>
          <master_item>
            <key>system.run[/usr/bin/AssetCacheManagerUtil status --json 2> /dev/null]</key>
          </master_item>
        </item>
        <item>
          <name>Total Stored from Origin</name>
          <type>DEPENDENT</type>
          <key>contentcache.total.storedfromorigin</key>
          <delay>0</delay>
          <history>7d</history>
          <units>B</units>
          <description>Total data downloaded from Apple's servers</description>
          <applications>
            <application>
              <name>macOS Content Cache</name>
            </application>
          </applications>
          <preprocessing>
            <step>
              <type>JSONPATH</type>
              <params>$.result.TotalBytesStoredFromOrigin</params>
            </step>
          </preprocessing>
          <master_item>
            <key>system.run[/usr/bin/AssetCacheManagerUtil status --json 2> /dev/null]</key>
          </master_item>
        </item>
        <item>
          <name>Content Cache Stats</name>
          <type>ZABBIX_ACTIVE</type>
          <key>system.run[/usr/bin/AssetCacheManagerUtil status --json 2> /dev/null]</key>
          <delay>60s</delay>
          <trends>0</trends>
          <value_type>TEXT</value_type>
          <applications>
            <application>
              <name>macOS Content Cache</name>
            </application>
          </applications>
        </item>
      </items>
    </template>
  </templates>
  <graphs>
    <graph>
      <name>macOS Content Cache Capacity</name>
      <graph_items>
        <graph_item>
          <color>000000</color>
          <item>
            <host>macOS Content Cache</host>
            <key>contentcache.cachelimit</key>
          </item>
        </graph_item>
        <graph_item>
          <sortorder>1</sortorder>
          <drawtype>FILLED_REGION</drawtype>
          <color>009999</color>
          <item>
            <host>macOS Content Cache</host>
            <key>contentcache.cacheused</key>
          </item>
        </graph_item>
      </graph_items>
    </graph>
    <graph>
      <name>macOS Content Cache Hit Rate</name>
      <graph_items>
        <graph_item>
          <color>00BB00</color>
          <item>
            <host>macOS Content Cache</host>
            <key>contentcache.total.hitrate</key>
          </item>
        </graph_item>
      </graph_items>
    </graph>
    <graph>
      <name>macOS Content Cache Stored Data</name>
      <type>STACKED</type>
      <graph_items>
        <graph_item>
          <color>4B4A67</color>
          <item>
            <host>macOS Content Cache</host>
            <key>contentcache.details.books</key>
          </item>
        </graph_item>
        <graph_item>
          <sortorder>1</sortorder>
          <color>DDD1C7</color>
          <item>
            <host>macOS Content Cache</host>
            <key>contentcache.details.icloud</key>
          </item>
        </graph_item>
        <graph_item>
          <sortorder>2</sortorder>
          <color>C2CFB2</color>
          <item>
            <host>macOS Content Cache</host>
            <key>contentcache.details.ios</key>
          </item>
        </graph_item>
        <graph_item>
          <sortorder>3</sortorder>
          <color>8DB580</color>
          <item>
            <host>macOS Content Cache</host>
            <key>contentcache.details.macos</key>
          </item>
        </graph_item>
        <graph_item>
          <sortorder>4</sortorder>
          <color>7E8987</color>
          <item>
            <host>macOS Content Cache</host>
            <key>contentcache.details.other</key>
          </item>
        </graph_item>
      </graph_items>
    </graph>
    <graph>
      <name>macOS Content Cache Traffic</name>
      <percent_left>95</percent_left>
      <graph_items>
        <graph_item>
          <color>009900</color>
          <item>
            <host>macOS Content Cache</host>
            <key>contentcache.bytes.returnedtoclients</key>
          </item>
        </graph_item>
        <graph_item>
          <sortorder>1</sortorder>
          <drawtype>FILLED_REGION</drawtype>
          <color>888888</color>
          <item>
            <host>macOS Content Cache</host>
            <key>contentcache.bytes.storedfromorigin</key>
          </item>
        </graph_item>
      </graph_items>
    </graph>
  </graphs>
</zabbix_export>